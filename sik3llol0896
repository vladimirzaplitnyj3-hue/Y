import os
import sys
import asyncio
import logging
import sqlite3
import re
import uuid
import aiohttp
from datetime import datetime, timedelta
from pyrogram import Client, filters, idle
from pyrogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery, ChatPermissions
from pyrogram.errors import PeerIdInvalid, UsernameInvalid, UserNotParticipant, ChatAdminRequired, MessageNotModified, FloodWait

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø ==========
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ë–û–¢–ê ==========
def get_config():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –ø—Ä—è–º–æ–µ –∑–∞–¥–∞–Ω–∏–µ"""
    API_ID = os.getenv("API_ID", "23258474")
    API_HASH = os.getenv("API_HASH", "f5dd3f52675030a650ca2259f9fb79ce")
    BOT_TOKEN = os.getenv("BOT_TOKEN", "8371079711:AAEibNv9L7j7W9noxOmj6bTFPDBOfQdBeek")
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º API_ID –≤ —á–∏—Å–ª–æ
    try:
        API_ID = int(API_ID)
    except ValueError:
        logger.error("API_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º!")
        API_ID = 23258474
    
    return API_ID, API_HASH, BOT_TOKEN

API_ID, API_HASH, BOT_TOKEN = get_config()

# –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Pyrogram
try:
    app = Client(
        "WARD_bot",
        api_id=API_ID,
        api_hash=API_HASH,
        bot_token=BOT_TOKEN,
        workers=20,
        sleep_threshold=60
    )
    logger.info("‚úÖ Pyrogram –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω")
except Exception as e:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Pyrogram: {e}")
    sys.exit(1)

# ========== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ==========
OWNERS = {
    "—Ö–æ–º—è–∫": {
        "id": "7557345458",
        "username": "XOMTG"
    },
    "–∏–Ω—Å–µ–π–Ω": {
        "id": "5960170498",
        "username": None
    }
}

WELCOME_IMAGE = "https://i.ibb.co/wZ61gwPk/IMG-20251216-230901-226.jpg"
WELCOME_ENABLED = False

# –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–µ–π
ROLE_IMAGES = {
    "–ù–µ—Ç –≤ –±–∞–∑–µ": "https://i.ibb.co/tTnCGRH5/IMG-20251218-220105-765.jpg",
    "–ü—Ä–æ–≤–µ—Ä–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º": "https://i.ibb.co/gLXJ061y/IMG-20251218-220907-223.jpg",
    "–°–∫–∞–º–º–µ—Ä": "https://i.ibb.co/bMj3HSV0/IMG-20251218-215910-457.jpg",
    "–í–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–º–º–µ—Ä": "https://i.ibb.co/N6d45hw8/IMG-20251218-215915-862.jpg",
    "–ü–ª–æ—Ö–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è": "https://i.ibb.co/GfNrHMjr/IMG-20251218-215913-756.jpg",
    "–ì–∞—Ä–∞–Ω—Ç": "https://i.ibb.co/LX6vfdM4/IMG-20251218-215928-663.jpg",
    "–î–∏—Ä–µ–∫—Ç–æ—Ä": "https://i.ibb.co/84PXfL67/IMG-20251218-215925-882.jpg",
    "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç": "https://i.ibb.co/7xrvpJrB/IMG-20251218-215906-668.jpg",
    "–°–æ–∑–¥–∞—Ç–µ–ª—å": "https://i.ibb.co/395GKLVr/IMG-20251217-215433-120.jpg",
    "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å": "https://i.ibb.co/xqDTJmfv/IMG-20251218-215922-130.jpg",
    "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä": "https://i.ibb.co/LX31HS1X/IMG-20251218-215907-525.jpg",
    "–°—Ç–∞–∂–µ—Ä": "https://i.ibb.co/fGdQYjXZ/IMG-20251218-215909-496.jpg",
    "–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "https://i.ibb.co/fGdQYjXZ/IMG-20251218-215909-496.jpg",
    "–í–æ–ª–æ–Ω—Ç–µ—Ä": "https://i.ibb.co/fGdQYjXZ/IMG-20251218-215909-496.jpg",
    "–í–ª–∞–¥–µ–ª–µ—Ü": "https://i.ibb.co/395GKLVr/IMG-20251217-215433-120.jpg",
    "–ö–æ–¥–µ—Ä": "https://i.ibb.co/LX6vfdM4/IMG-20251218-215928-663.jpg",
    "–î–∏–∑–∞–π–Ω–µ—Ä": "https://i.ibb.co/xqDTJmfv/IMG-20251218-215922-130.jpg",
    "–ê–¥–º–∏–Ω": "https://i.ibb.co/LX6vfdM4/IMG-20251218-215928-663.jpg",
}

SCAM_RATING_OPTIONS = {
    1: {"text": "1 - –í–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–º", "chance": "70-80%", "role_name": "–í–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–º–º–µ—Ä"},
    2: {"text": "2 - –°–æ–º–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è", "chance": "59-65%", "role_name": "–í–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–º–º–µ—Ä"},
    3: {"text": "3 - –ü–µ—Ç—É—Ö", "chance": "90-99%", "role_name": "–°–∫–∞–º–º–µ—Ä"},
    4: {"text": "4 - –°–ö–ê–ú–ú–ï–†", "chance": "100%", "role_name": "–°–∫–∞–º–º–µ—Ä"},
}

# ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
RATE_LIMITS = {}
CHECK_LIMIT_SECONDS = 5
PENDING_SCAM_ENTRIES = {}
MENTOR_REQUESTS = {}
STAFF_CACHE = {}
USER_INFO_CACHE = {}
conn = None
cursor = None

# ========== –§–£–ù–ö–¶–ò–ò –ë–ê–ó–´ –î–ê–ù–ù–´–• ==========
def init_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    global conn, cursor
    
    try:
        conn = sqlite3.connect('WARD_database.db', check_same_thread=False)
        cursor = conn.cursor()
        logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
        
        # –°–æ–∑–¥–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
        create_tables()
        return True
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        return False

def create_tables():
    """–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ç–∞–±–ª–∏—Ü"""
    tables_queries = [
        """CREATE TABLE IF NOT EXISTS scammers (
            user_id TEXT PRIMARY KEY, 
            reason TEXT, 
            proof_link TEXT, 
            scam_rating INTEGER DEFAULT 4
        )""",
        "CREATE TABLE IF NOT EXISTS presidents (user_id TEXT PRIMARY KEY)",
        "CREATE TABLE IF NOT EXISTS directors (user_id TEXT PRIMARY KEY)",
        "CREATE TABLE IF NOT EXISTS admins (user_id TEXT PRIMARY KEY)",
        "CREATE TABLE IF NOT EXISTS deputies (user_id TEXT PRIMARY KEY)",
        """CREATE TABLE IF NOT EXISTS trusted (
            user_id TEXT PRIMARY KEY, 
            guarantor_id TEXT
        )""",
        "CREATE TABLE IF NOT EXISTS volunteers (user_id TEXT PRIMARY KEY)",
        "CREATE TABLE IF NOT EXISTS coders (user_id TEXT PRIMARY KEY)",
        "CREATE TABLE IF NOT EXISTS employees (user_id TEXT PRIMARY KEY)",
        "CREATE TABLE IF NOT EXISTS moderators (user_id TEXT PRIMARY KEY)",
        "CREATE TABLE IF NOT EXISTS designers (user_id TEXT PRIMARY KEY)",
        """CREATE TABLE IF NOT EXISTS reputation (
            user_id TEXT PRIMARY KEY, 
            count INTEGER DEFAULT 0
        )""",
        """CREATE TABLE IF NOT EXISTS user_settings (
            user_id TEXT PRIMARY KEY, 
            country TEXT
        )""",
        """CREATE TABLE IF NOT EXISTS reprimands (
            user_id TEXT PRIMARY KEY, 
            count INTEGER DEFAULT 0
        )""",
        """CREATE TABLE IF NOT EXISTS mentorship (
            volunteer_id TEXT PRIMARY KEY, 
            mentor_id TEXT
        )"""
    ]
    
    for query in tables_queries:
        try:
            cursor.execute(query)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: {e}")
    
    conn.commit()
    logger.info("‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")

# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
def get_russian_date():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"""
    months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', 
              '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è']
    now = datetime.now()
    return f"{now.day} {months[now.month - 1]} {now.year} | {now.strftime('%H:%M')}"

def get_clean_id(text):
    """–û—á–∏—â–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ—Ç @ –∏ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤"""
    return text.lstrip("@").strip() if text else ""

def is_owner(user_id, username):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º"""
    user_id_str = str(user_id)
    username_lower = username.lower() if username else None
    
    for owner_data in OWNERS.values():
        if owner_data["id"] == user_id_str:
            return True
        if username_lower and owner_data["username"] and owner_data["username"].lower() == username_lower:
            return True
    
    return False

def is_president(user_id):
    return bool(cursor.execute("SELECT 1 FROM presidents WHERE user_id = ?", (str(user_id),)).fetchone())

def is_director(user_id):
    return bool(cursor.execute("SELECT 1 FROM directors WHERE user_id = ?", (str(user_id),)).fetchone())

def is_admin(user_id):
    return bool(cursor.execute("SELECT 1 FROM admins WHERE user_id = ?", (str(user_id),)).fetchone())

def is_deputy(user_id):
    return bool(cursor.execute("SELECT 1 FROM deputies WHERE user_id = ?", (str(user_id),)).fetchone())

def is_coder(user_id):
    return bool(cursor.execute("SELECT 1 FROM coders WHERE user_id = ?", (str(user_id),)).fetchone())

def is_employee(user_id):
    return bool(cursor.execute("SELECT 1 FROM employees WHERE user_id = ?", (str(user_id),)).fetchone())

def is_moderator(user_id):
    return bool(cursor.execute("SELECT 1 FROM moderators WHERE user_id = ?", (str(user_id),)).fetchone())

def is_designer(user_id):
    return bool(cursor.execute("SELECT 1 FROM designers WHERE user_id = ?", (str(user_id),)).fetchone())

def is_volunteer(user_id):
    return bool(cursor.execute("SELECT 1 FROM volunteers WHERE user_id = ?", (str(user_id),)).fetchone())

def is_staff(user_id):
    return is_employee(user_id)

def is_any_staff(user_id, username=None):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª—é–±—ã–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º"""
    if username and is_owner(user_id, username):
        return True
    if is_president(user_id):
        return True
    if is_director(user_id):
        return True
    if is_admin(user_id) or is_coder(user_id) or is_employee(user_id) or is_moderator(user_id) or is_volunteer(user_id) or is_designer(user_id) or is_deputy(user_id):
        return True
    return False

def can_moderate(user_id, username):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é"""
    return is_owner(user_id, username) or is_president(user_id) or is_director(user_id) or is_admin(user_id)

def can_temp_moderate(user_id, username):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é"""
    if can_moderate(user_id, username):
        return True
    if is_deputy(user_id) or is_moderator(user_id):
        return True
    return False

def get_reputation(user_id):
    result = cursor.execute("SELECT count FROM reputation WHERE user_id = ?", (str(user_id),)).fetchone()
    return result[0] if result else 0

def db_increment_reputation(user_id):
    cursor.execute("""
        INSERT INTO reputation (user_id, count) VALUES (?, 1) 
        ON CONFLICT(user_id) DO UPDATE SET count = count + 1
    """, (str(user_id),))
    conn.commit()

def set_mentor(volunteer_id, mentor_id):
    cursor.execute("INSERT OR REPLACE INTO mentorship (volunteer_id, mentor_id) VALUES (?, ?)", 
                   (str(volunteer_id), str(mentor_id)))
    conn.commit()

def get_mentor_id(volunteer_id):
    result = cursor.execute("SELECT mentor_id FROM mentorship WHERE volunteer_id = ?", (str(volunteer_id),)).fetchone()
    return result[0] if result else None

def get_reprimands_count(user_id):
    result = cursor.execute("SELECT count FROM reprimands WHERE user_id = ?", (str(user_id),)).fetchone()
    return result[0] if result else 0

def add_reprimand(user_id):
    cursor.execute("""
        INSERT INTO reprimands (user_id, count) VALUES (?, 1) 
        ON CONFLICT(user_id) DO UPDATE SET count = count + 1
    """, (str(user_id),))
    conn.commit()
    return get_reprimands_count(user_id)

def clear_reprimands(user_id):
    cursor.execute("DELETE FROM reprimands WHERE user_id = ?", (str(user_id),))
    conn.commit()

def remove_all_staff_roles(user_id):
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ä–æ–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"""
    tables = ['presidents', 'directors', 'admins', 'coders', 'moderators', 'employees', 'volunteers', 'designers', 'deputies']
    user_id_str = str(user_id)
    for table in tables:
        cursor.execute(f"DELETE FROM {table} WHERE user_id = ?", (user_id_str,))
    conn.commit()

def db_set_country(user_id, country_text):
    cursor.execute("INSERT OR REPLACE INTO user_settings (user_id, country) VALUES (?, ?)", 
                   (str(user_id), country_text))
    conn.commit()

def db_get_country(user_id):
    result = cursor.execute("SELECT country FROM user_settings WHERE user_id = ?", (str(user_id),)).fetchone()
    return result[0] if result else "Unknown"

def db_add_scammer_final(user_id, reason, proof_link, scam_rating):
    try:
        cursor.execute("""
            INSERT OR REPLACE INTO scammers (user_id, reason, proof_link, scam_rating) 
            VALUES (?, ?, ?, ?)
        """, (str(user_id), reason, proof_link, scam_rating))
        conn.commit()
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–∫–∞–º–º–µ—Ä–∞: {e}")
        return False

def db_delete(table, user_id):
    cursor.execute(f"DELETE FROM {table} WHERE user_id = ?", (str(user_id),))
    conn.commit()
    return cursor.rowcount > 0

async def get_message_link(client, message):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    chat_id = message.chat.id
    message_id = message.id
    if message.chat.username:
        return f"https://t.me/{message.chat.username}/{message_id}"
    else:
        raw_chat_id = str(chat_id).replace("-100", "")
        return f"https://t.me/c/{raw_chat_id}/{message_id}"

async def get_guarantor_link(client, target_id):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∞"""
    result = cursor.execute("SELECT guarantor_id FROM trusted WHERE user_id = ?", (str(target_id),)).fetchone()
    if not result or not result[0]:
        return None
    
    guarantor_id = result[0]
    try:
        guarantor_info = await client.get_chat(int(guarantor_id))
        name = guarantor_info.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        username = guarantor_info.username
        
        if username:
            link = f"https://t.me/{username}"
            display_name = f"**{name}** (@{username})"
        else:
            link = f"tg://user?id={guarantor_id}"
            display_name = f"**{name}** (ID: {guarantor_id})"
        
        return f"üí† **–ü—Ä–æ–≤–µ—Ä–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º:** [–ì–∞—Ä–∞–Ω—Ç {display_name}]({link})"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–∞—Ä–∞–Ω—Ç–µ: {e}")
        return None

async def get_mentor_link(client, volunteer_id):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –∫—É—Ä–∞—Ç–æ—Ä–∞"""
    mentor_id = get_mentor_id(volunteer_id)
    if not mentor_id:
        return None
    
    try:
        mentor_info = await client.get_chat(int(mentor_id))
        name = mentor_info.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        username = mentor_info.username
        
        if username:
            link = f"https://t.me/{username}"
            display_name = f"**{name}** (@{username})"
        else:
            link = f"tg://user?id={mentor_id}"
            display_name = f"**{name}** (ID: {mentor_id})"

        return f"\nüéì **–ö—É—Ä–∞—Ç–æ—Ä:** [–ö—É—Ä–∞—Ç–æ—Ä {display_name}]({link})"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—É—Ä–∞—Ç–æ—Ä–µ: {e}")
        return None

def determine_user_role(user_id, username):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    user_id_str = str(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–ª–æ—Ö–æ–π —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
    if get_reprimands_count(user_id_str) >= 2:
        return "–ü–ª–æ—Ö–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–∫–∞–º–º–µ—Ä–æ–º
    scam_data = cursor.execute("SELECT scam_rating FROM scammers WHERE user_id = ?", (user_id_str,)).fetchone()
    if scam_data and scam_data[0] is not None:
        rating = scam_data[0]
        if rating in [3, 4]:
            return "–°–∫–∞–º–º–µ—Ä"
        elif rating in [1, 2]:
            return "–í–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–º–º–µ—Ä"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≥–∞—Ä–∞–Ω—Ç–æ–º
    if cursor.execute("SELECT 1 FROM trusted WHERE user_id = ?", (user_id_str,)).fetchone():
        return "–ü—Ä–æ–≤–µ—Ä–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
    if is_owner(user_id_str, username):
        return "–°–æ–∑–¥–∞—Ç–µ–ª—å"
    elif is_president(user_id_str):
        return "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç"
    elif is_director(user_id_str):
        return "–î–∏—Ä–µ–∫—Ç–æ—Ä"
    elif is_admin(user_id_str):
        return "–ì–∞—Ä–∞–Ω—Ç"
    elif is_deputy(user_id_str):
        return "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å"
    elif is_coder(user_id_str):
        return "–ì–∞—Ä–∞–Ω—Ç"
    elif is_designer(user_id_str):
        return "–î–∏–∑–∞–π–Ω–µ—Ä"
    elif is_employee(user_id_str):
        return "–°–æ—Ç—Ä—É–¥–Ω–∏–∫"
    elif is_moderator(user_id_str):
        return "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä"
    elif is_volunteer(user_id_str):
        return "–°—Ç–∞–∂–µ—Ä"
    
    return "–ù–µ—Ç –≤ –±–∞–∑–µ"

def generate_card_text(user_id, username, name, guarantor_link=None, mentor_link=None):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id_str = str(user_id)
    country = db_get_country(user_id_str)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏
    is_owner_flag = is_owner(user_id_str, username)
    is_president_flag = is_president(user_id_str)
    is_coder_flag = is_coder(user_id_str)
    is_director_flag = is_director(user_id_str)
    is_admin_flag = is_admin(user_id_str)
    is_deputy_flag = is_deputy(user_id_str)
    is_employee_flag = is_employee(user_id_str)
    is_moderator_flag = is_moderator(user_id_str)
    is_volunteer_flag = is_volunteer(user_id_str)
    is_designer_flag = is_designer(user_id_str)
    
    # –ü–ª–æ—Ö–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è
    reprimand_count = get_reprimands_count(user_id_str)
    reprimand_text = ""
    bad_reputation_label = ""
    
    if reprimand_count > 0:
        reprimand_text = f"\n‚ö†Ô∏è **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≥–æ–≤–æ—Ä–æ–≤:** {reprimand_count}/3"
    if reprimand_count >= 2:
        bad_reputation_label = " ‚ö†Ô∏è [–ü–ª–æ—Ö–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è]"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–∞–º
    scam_data = cursor.execute("SELECT reason, proof_link, scam_rating FROM scammers WHERE user_id = ?", (user_id_str,)).fetchone()
    
    if scam_data:
        reason = scam_data[0] or "–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ"
        proof_link = scam_data[1]
        scam_rating = scam_data[2] if scam_data[2] is not None else 4
        rating_info = SCAM_RATING_OPTIONS.get(scam_rating, SCAM_RATING_OPTIONS[4])
        status, chance, color, footer = rating_info["text"], rating_info["chance"], "‚ùå", f"‚ö†Ô∏è **–ü–†–ò–ß–ò–ù–ê:** {reason}"
        if proof_link:
            footer += f"\nüîó **–î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê:** [–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä—É—Ñ—ã]({proof_link})"
    
    elif is_owner_flag:
        owner_name = None
        for owner_n, data in OWNERS.items():
            if data["id"] == user_id_str or (data["username"] and data["username"].lower() == (username or "").lower()):
                owner_name = owner_n
                break
        
        status, chance, color, footer = "–°–æ–∑–¥–∞—Ç–µ–ª—å üëë", "0%", "‚úÖ", "–î–æ–≤–µ—Ä–µ–Ω–Ω—ã–π —Å–æ–∑–¥–∞—Ç–µ–ª—å [WARD AntiScam](https://t.me/WardReport)."
        name = owner_name or name
    
    elif is_president_flag:
        status, chance, color, footer = "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç üëë", "0%", "‚úÖ", "–í—ã—Å—à–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å [WARD AntiScam](https://t.me/WardReport)."
    
    elif is_coder_flag:
        status, chance, color, footer = "–ö–æ–¥–µ—Ä üíª", "0%", "‚úÖ", "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã [WARD](https://t.me/WardReport)."
    
    elif is_designer_flag:
        status, chance, color, footer = "–î–∏–∑–∞–π–Ω–µ—Ä üé®", "0%", "‚úÖ", "–î–∏–∑–∞–π–Ω–µ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã [WARD](https://t.me/WardReport)."
    
    elif is_director_flag:
        status, chance, color, footer = "–î–∏—Ä–µ–∫—Ç–æ—Ä üéØ", "0%", "‚úÖ", "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ [WARD](https://t.me/WardReport)."
    
    elif is_admin_flag:
        status, chance, color, footer = "–ì–∞—Ä–∞–Ω—Ç üõ°", "0%", "‚úÖ", "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≥–∞—Ä–∞–Ω—Ç —Å–µ—Ä–≤–∏—Å–∞ [WARD AntiScam](https://t.me/WardReport)."
    
    elif is_deputy_flag:
        status, chance, color, footer = "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å üíº", "1-5%", "‚úÖ", "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å —Å–µ—Ä–≤–∏—Å–∞ [WARD](https://t.me/WardReport)."
    
    elif is_employee_flag or is_volunteer_flag:
        status, chance, color, footer = "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ (–°—Ç–∞–∂–µ—Ä) üé©", "5-15%", "‚úÖ", "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–µ—Ä–≤–∏—Å–∞ [WARD](https://t.me/WardReport)."
    
    elif is_moderator_flag:
        status, chance, color, footer = "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä üî®", "15-30%", "‚úÖ", "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–µ—Ä–≤–∏—Å–∞ [WARD](https://t.me/WardReport)."
    
    elif cursor.execute("SELECT 1 FROM trusted WHERE user_id = ?", (user_id_str,)).fetchone():
        status, chance, color, footer = "–ü—Ä–æ–≤–µ—Ä–µ–Ω –≥–∞—Ä–∞–Ω—Ç–æ–º üí†", "10-25%", "‚úÖ", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –¥–æ–≤–µ—Ä–∏–µ —Å–µ—Ä–≤–∏—Å–∞ [WARD](https://t.me/WardReport)."
    
    else:
        status, chance, color, footer = "–ù–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ üë§", "40-50%", "‚ö†Ô∏è", "–ß–µ–ª–æ–≤–µ–∫–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ [WARD](https://t.me/WardReport) (–†–∏—Å–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)."

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    staff_label = " ‚úÖ [–ü–µ—Ä—Å–æ–Ω–∞–ª –±–∞–∑—ã]" if is_any_staff(user_id, username) else ""
    trusted_label = f"\n{guarantor_link}" if guarantor_link else ""
    mentor_label = mentor_link if mentor_link else ""
    leaked = get_reputation(user_id_str)
    display_link = f"@{username}" if username else "–ù–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞"
    
    if is_owner_flag and country == "Unknown":
        country = "Azerbaijan üá¶üáø"
    
    text = (
        f"üë§ **{name}** | {display_link} | [`{user_id_str}`]\n\n"
        f"{color} **–°—Ç–∞—Ç—É—Å:** {status}{bad_reputation_label}\n"
        f"üìâ **–®–∞–Ω—Å —Å–∫–∞–º–∞:** {chance}{staff_label}{reprimand_text}{trusted_label}{mentor_label}\n"
        f"üåç **–°—Ç—Ä–∞–Ω–∞:** {country}\n"
        f"üö´ **–°–∫–∞–º–º–µ—Ä–æ–≤ —Å–ª–∏—Ç–æ:** {leaked}\n\n"
        f"{footer}\n"
        f"–í—Å–µ–≥–¥–∞ –∏–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –≥–∞—Ä–∞–Ω—Ç–æ–≤ **[WARD AntiScam](https://t.me/WardReport)**, —á—Ç–æ–±—ã —Å–¥–µ–ª–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ.\n\n"
        f"üìÖ {get_russian_date()} | ü§ñ @WARDANTISCAMBOT"
    )
    
    return text

def get_profile_keyboard(user_id, username):
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å"""
    url = f"https://t.me/{username}" if username else f"tg://user?id={user_id}"
    return InlineKeyboardMarkup([[InlineKeyboardButton("üîó –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", url=url)]])

async def find_target(client, message, arg_text=None):
    """–ù–∞—Ö–æ–¥–∏—Ç —Ü–µ–ª—å –ø–æ ID –∏–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º—É"""
    if message.reply_to_message and message.reply_to_message.from_user:
        return message.reply_to_message.from_user, None
    
    if not arg_text:
        return None, None
    
    clean = get_clean_id(arg_text)
    if clean.lower() in ["–º–∏", "me", "—è"]:
        return message.from_user, None

    try:
        if clean.isdigit():
            chat = await client.get_chat(int(clean))
        else:
            chat = await client.get_chat(clean)
        
        return chat, None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ü–µ–ª–∏: {e}")
        return None, clean

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========
def welcome_keyboard():
    return InlineKeyboardMarkup([[InlineKeyboardButton("üåü –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É", callback_data="start_work")]])

def main_menu_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å ‚ÑπÔ∏è", callback_data="my_profile")],
        [
            InlineKeyboardButton("–°–ª–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞ üò°", callback_data="report_scam"),
            InlineKeyboardButton("–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚ùì", callback_data="faq")
        ],
        [InlineKeyboardButton("–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–∞–∑—ã üë•", callback_data="list_all_staff")],
        [
            InlineKeyboardButton("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìä", callback_data="stats"),
            InlineKeyboardButton("–ü—Ä–µ–º–∏—É–º üå∏", callback_data="premium")
        ]
    ])

def scam_report_keyboard():
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üì© –Ω–∞—à–∞ –ø—Ä–µ–¥–ª–æ–∂–∫–∞", url="https://t.me/WardReport"),
            InlineKeyboardButton("üìã –Ω–∞—à –Ω–∞–±–æ—Ä", url="https://t.me/+Aatv6sPwE34zYzRi")
        ],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
    ])

def select_country_keyboard():
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üá∑üá∫ –†–æ—Å—Å–∏—è", callback_data="country_Russia üá∑üá∫"),
            InlineKeyboardButton("üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞", callback_data="country_Ukraine üá∫üá¶")
        ],
        [
            InlineKeyboardButton("üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å", callback_data="country_Belarus üáßüáæ"),
            InlineKeyboardButton("üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", callback_data="country_Kazakhstan üá∞üáø")
        ],
        [
            InlineKeyboardButton("üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è", callback_data="country_Germany üá©üá™"),
            InlineKeyboardButton("üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è", callback_data="country_France üá´üá∑")
        ],
        [
            InlineKeyboardButton("üáµüá± –ü–æ–ª—å—à–∞", callback_data="country_Poland üáµüá±"),
            InlineKeyboardButton("üá∫üá∏ –°–®–ê", callback_data="country_USA üá∫üá∏")
        ],
        [
            InlineKeyboardButton("üá¶üáø –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω", callback_data="country_Azerbaijan üá¶üáø"),
            InlineKeyboardButton("üè≥Ô∏è –°–∫—Ä—ã—Ç—å", callback_data="country_Unknown")
        ],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å", callback_data="my_profile")]
    ])

def back_to_menu_keyboard():
    return InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_menu")]])

def get_scam_rating_keyboard():
    buttons = []
    for rating, data in SCAM_RATING_OPTIONS.items():
        buttons.append([InlineKeyboardButton(f"{data['text']} ({data['chance']})", 
                       callback_data=f"set_scam_rating_{rating}")])
    return InlineKeyboardMarkup(buttons)

def staff_categories_keyboard():
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üëë –°–æ–∑–¥–∞—Ç–µ–ª–∏", callback_data="staff_category_owners"),
            InlineKeyboardButton("üéØ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç—ã", callback_data="staff_category_presidents")
        ],
        [
            InlineKeyboardButton("üî• –î–∏—Ä–µ–∫—Ç–æ—Ä–∞", callback_data="staff_category_directors"),
            InlineKeyboardButton("üõ° –ì–∞—Ä–∞–Ω—Ç—ã", callback_data="staff_category_admins")
        ],
        [
            InlineKeyboardButton("üíº –ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª–∏", callback_data="staff_category_deputies"),
            InlineKeyboardButton("üî® –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã", callback_data="staff_category_moderators")
        ],
        [
            InlineKeyboardButton("üíª –ö–æ–¥–µ—Ä—ã", callback_data="staff_category_coders"),
            InlineKeyboardButton("üé® –î–∏–∑–∞–π–Ω–µ—Ä—ã", callback_data="staff_category_designers")
        ],
        [
            InlineKeyboardButton("üé© –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (–°—Ç–∞–∂–µ—Ä—ã)", callback_data="staff_category_employees")
        ],
        [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_menu")]
    ])

async def fetch_staff_info():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–ª–µ"""
    staff_tables = ['admins', 'coders', 'employees', 'volunteers', 
                   'moderators', 'directors', 'presidents', 'designers', 'deputies']
    
    for table in staff_tables:
        cursor.execute(f"SELECT user_id FROM {table}")
        user_ids = [row[0] for row in cursor.fetchall()]
        STAFF_CACHE[table] = []

        for user_id in user_ids:
            try:
                user_info = await app.get_chat(int(user_id))
                info = {
                    'id': user_id,
                    'name': user_info.first_name or f"ID: {user_id}",
                    'username': user_info.username
                }
                STAFF_CACHE[table].append(info)
                USER_INFO_CACHE[user_id] = info
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {user_id}: {e}")
                STAFF_CACHE[table].append({
                    'id': user_id,
                    'name': f"ID: {user_id}",
                    'username': None
                })

def parse_time(time_str):
    """–ü–∞—Ä—Å–∏—Ç –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ 30m, 2h, 1d"""
    time_str = time_str.lower()
    match = re.match(r"(\d+)([smhd])", time_str)
    if not match:
        return None, "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞."
    
    value = int(match.group(1))
    unit = match.group(2)
    
    if unit == 's':
        delta = timedelta(seconds=value)
    elif unit == 'm':
        delta = timedelta(minutes=value)
    elif unit == 'h':
        delta = timedelta(hours=value)
    elif unit == 'd':
        delta = timedelta(days=value)
    else:
        return None, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω–∏."
    
    return datetime.now() + delta, None

# ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ë–û–¢–ê ==========
@app.on_message(filters.command("start") & filters.private)
async def start_cmd(client, message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    username = message.from_user.username or message.from_user.first_name
    
    welcome_text = (
        f"–ü—Ä–∏–≤–µ—Ç {username}!\n\n"
        f"–ú—ã –∞–Ω—Ç–∏—Å–∫–∞–º –±–∞–∑–∞ [WARD AntiScam](https://t.me/WardReport) –∫–æ—Ç–æ—Ä–∞—è –±–æ—Ä–µ—Ç—Å—è —Å–æ —Å–∫–∞–º–æ–º.\n\n"
        f"–ú—ã –ø–æ–º–æ–∂–µ–º —Ç–µ–±–µ:\n"
        f"‚Ä¢ –ù–∞–π—Ç–∏ –≥–∞—Ä–∞–Ω—Ç–æ–≤\n"
        f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Å–∫–∞–º\n"
        f"‚Ä¢ –ó–∞—â–∏—â–∞—Ç—å —Ç–≤–æ–∏ —Å–¥–µ–ª–∫–∏"
    )
    
    try:
        await message.reply_photo(
            photo=WELCOME_IMAGE,
            caption=welcome_text,
            reply_markup=welcome_keyboard()
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ start: {e}")
        await message.reply(welcome_text, reply_markup=welcome_keyboard())

@app.on_callback_query()
async def handle_callbacks(client, callback_query: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤"""
    data = callback_query.data
    user = callback_query.from_user
    
    try:
        await callback_query.answer()
        
        if data == "start_work":
            await callback_query.message.edit_text(
                "üëã **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ [WARD AntiScam](https://t.me/WardReport)!**\n\n"
                "–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å. –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=main_menu_keyboard()
            )
        
        elif data.startswith("approve_scam_"):
            req_id = data.split("_")[-1]
            request_data = MENTOR_REQUESTS.get(req_id)
            
            if not request_data:
                try:
                    await callback_query.message.delete()
                except:
                    pass
                return
            
            target_id = request_data['target_id']
            reason = request_data['reason']
            proof_link = request_data['proof_link']
            rating = request_data['rating']
            volunteer_id = request_data['volunteer_id']
            
            if db_add_scammer_final(target_id, reason, proof_link, rating):
                db_increment_reputation(volunteer_id)
                del MENTOR_REQUESTS[req_id]
                await callback_query.message.edit_text(f"‚úÖ **–í—ã –æ–¥–æ–±—Ä–∏–ª–∏ –∑–∞–Ω–µ—Å–µ–Ω–∏–µ!**\nID —Å–∫–∞–º–µ—Ä–∞: `{target_id}`")
            else:
                await callback_query.message.edit_text("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")

        elif data.startswith("reject_scam_"):
            req_id = data.split("_")[-1]
            request_data = MENTOR_REQUESTS.get(req_id)
            if request_data:
                volunteer_id = request_data['volunteer_id']
                del MENTOR_REQUESTS[req_id]
                await callback_query.message.edit_text("‚ùå **–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –∑–∞–ø—Ä–æ—Å.**")
            else:
                await callback_query.message.delete()

        elif data.startswith("set_scam_rating_"):
            rating = int(data.split("_")[-1])
            if user.id not in PENDING_SCAM_ENTRIES:
                await callback_query.message.edit_text("‚ùå –ó–∞–ø—Ä–æ—Å —É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                return
            
            target_id, reason, proof_link = PENDING_SCAM_ENTRIES.pop(user.id)
            
            if db_add_scammer_final(target_id, reason, proof_link, rating):
                db_increment_reputation(user.id)
                rating_text = SCAM_RATING_OPTIONS[rating]['text']
                await callback_query.message.edit_text(
                    f"‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É!**\n"
                    f"ID: `{target_id}`\n"
                    f"–†–µ–π—Ç–∏–Ω–≥: **{rating_text}**\n"
                    f"–ü—Ä–∏—á–∏–Ω–∞: `{reason}`"
                )
            
            return
        
        elif data == "my_profile":
            text = generate_card_text(user.id, user.username, user.first_name)
            kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("üè≥Ô∏è –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É", callback_data="set_country")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
            ])
            
            await callback_query.message.edit_text(text, reply_markup=kb)
        
        elif data == "report_scam":
            scam_text = (
                "–¢–ï–ë–Ø –°–ö–ê–ú–ê–ù–£–õ–ò?üò°üò°üò°üò°üò°üò°üò°\n\n"
                "–¢–û–ì–î–ê –°–†–û–ß–ù–û –°–†–û–ß–ù–û –û–¢–ü–†–ê–í–¨ –í –ù–ê–®–£ –ü–†–ï–î–õ–û–ñ–ö–£ [WARD AntiScam](https://t.me/WardReport)\n\n"
                "–ú–´ –ó–ê–ù–ï–°–ï–ú –≠–¢–û–ì–û –°–ö–ê–ú–ï–†–ê –ò –û–ù –ë–û–õ–¨–®–ï –ù–ò–ö–û–ì–î–ê –ù–ï –ë–£–î–ï–¢ –°–ö–ê–ú–ò–¢–¨"
            )
            await callback_query.message.edit_text(scam_text, reply_markup=scam_report_keyboard())
        
        elif data == "list_all_staff":
            await callback_query.message.edit_text(
                "üë• **–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ [WARD AntiScam](https://t.me/WardReport):**",
                reply_markup=staff_categories_keyboard()
            )
        
        elif data == "faq":
            text = (
                "‚ùì **–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)**\n\n"
                "**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?** –ù–∞–ø–∏—à–∏ `–ß–µ–∫ @username`.\n"
                "**–ö–∞–∫ —Å—Ç–∞—Ç—å –ì–∞—Ä–∞–Ω—Ç–æ–º?** –°—Ç–∞—Ç—É—Å –≤—ã–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –°–æ–∑–¥–∞—Ç–µ–ª—å.\n"
                "**–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫–∞–º–º–µ—Ä–∞?** –ö–æ–º–∞–Ω–¥–∞ `/scam` –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—É.\n"
                "**–ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω—É?** –í –ø—Ä–æ—Ñ–∏–ª–µ –Ω–∞–∂–º–∏ '–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É'."
            )
            await callback_query.message.edit_text(text, reply_markup=back_to_menu_keyboard())
        
        elif data == "stats":
            total_scammers = cursor.execute("SELECT COUNT(user_id) FROM scammers").fetchone()[0] or 0
            total_presidents = cursor.execute("SELECT COUNT(user_id) FROM presidents").fetchone()[0] or 0
            total_directors = cursor.execute("SELECT COUNT(user_id) FROM directors").fetchone()[0] or 0
            total_admins = cursor.execute("SELECT COUNT(user_id) FROM admins").fetchone()[0] or 0
            total_deputies = cursor.execute("SELECT COUNT(user_id) FROM deputies").fetchone()[0] or 0
            total_volunteers = cursor.execute("SELECT COUNT(user_id) FROM volunteers").fetchone()[0] or 0
            total_coders = cursor.execute("SELECT COUNT(user_id) FROM coders").fetchone()[0] or 0
            total_employees = cursor.execute("SELECT COUNT(user_id) FROM employees").fetchone()[0] or 0
            total_moderators = cursor.execute("SELECT COUNT(user_id) FROM moderators").fetchone()[0] or 0
            total_designers = cursor.execute("SELECT COUNT(user_id) FROM designers").fetchone()[0] or 0
            total_rep = cursor.execute("SELECT IFNULL(SUM(count), 0) FROM reputation").fetchone()[0] or 0
            
            text = (
                f"üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ [WARD AntiScam](https://t.me/WardReport)**\n\n"
                f"‚õî –°–∫–∞–º–µ—Ä–æ–≤ –≤ –±–∞–∑–µ: **{total_scammers}**\n"
                f"üëë –°–æ–∑–¥–∞—Ç–µ–ª–µ–π: **{len(OWNERS)}**\n"
                f"üéØ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤: **{total_presidents}**\n"
                f"üî• –î–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤: **{total_directors}**\n"
                f"üõ° –ì–∞—Ä–∞–Ω—Ç–æ–≤: **{total_admins}**\n"
                f"üíº –ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª–µ–π: **{total_deputies}**\n"
                f"üíª –ö–æ–¥–µ—Ä–æ–≤: **{total_coders}**\n"
                f"üé® –î–∏–∑–∞–π–Ω–µ—Ä–æ–≤: **{total_designers}**\n"
                f"üî® –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤: **{total_moderators}**\n"
                f"üé© –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–°—Ç–∞–∂–µ—Ä–æ–≤): **{total_employees}**\n"
                f"ü§ù –û–±—â–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è (—Å–ª–∏—Ç–æ): **{total_rep}**\n"
            )
            await callback_query.message.edit_text(text, reply_markup=back_to_menu_keyboard())

        elif data == "premium":
            await callback_query.message.edit_text(
                "üå∏ **–ü—Ä–µ–º–∏—É–º-–¥–æ—Å—Ç—É–ø [WARD AntiScam](https://t.me/WardReport)**\n\n"
                "–§—É–Ω–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –°–∫–≤–æ –ø–æ—è–≤–∏—Ç—Å—è!",
                reply_markup=back_to_menu_keyboard()
            )
        
        elif data == "back_to_menu":
            await callback_query.message.edit_text(
                "üëã **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é [WARD AntiScam](https://t.me/WardReport)**\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=main_menu_keyboard()
            )
        
        elif data == "set_country":
            await callback_query.message.edit_text(
                "üåç **–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Å—Ç—Ä–∞–Ω—É –∏–∑ —Å–ø–∏—Å–∫–∞:**",
                reply_markup=select_country_keyboard()
            )
        
        elif data.startswith("country_"):
            selected_country = data.split("_", 1)[1]
            db_set_country(user.id, selected_country)
            
            text = generate_card_text(user.id, user.username, user.first_name)
            kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("üè≥Ô∏è –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É", callback_data="set_country")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
            ])
            
            await callback_query.message.edit_text(text, reply_markup=kb)
        
        elif data.startswith("staff_category_"):
            category = data.split("_")[-1]
            
            if category == "owners":
                text = "üëë **–°–æ–∑–¥–∞—Ç–µ–ª–∏ –±–∞–∑—ã [WARD AntiScam](https://t.me/WardReport):**\n\n"
                for owner_name, owner_data in OWNERS.items():
                    username = owner_data["username"]
                    user_id = owner_data["id"]
                    display_name = f"@{username}" if username else f"ID: {user_id}"
                    text += f"‚Ä¢ **{owner_name}** - {display_name}\n"
                
                await callback_query.message.edit_text(
                    text,
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data="list_all_staff")]])
                )
            else:
                await callback_query.message.edit_text(
                    f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è {category} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="list_all_staff")]])
                )
        
    except MessageNotModified:
        pass
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ callback: {e}")

@app.on_message(filters.regex(r"(?i)^(—á–µ–∫|check|/check)\b"))
async def check_handler(client, message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏"""
    user_id = message.from_user.id
    current_time = datetime.now()
    
    # –õ–∏–º–∏—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if not can_moderate(user_id, message.from_user.username):
        if user_id in RATE_LIMITS:
            if (current_time - RATE_LIMITS[user_id]).total_seconds() < CHECK_LIMIT_SECONDS:
                await message.reply("‚è∞ –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —á–µ–∫–æ–º.")
                return
        RATE_LIMITS[user_id] = current_time
    
    # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏
    parts = message.text.split(maxsplit=1)
    args = parts[1] if len(parts) > 1 else None
    
    target = None
    if message.reply_to_message:
        target = message.reply_to_message.from_user
    elif args:
        clean = get_clean_id(args)
        if clean.lower() in ["–º–∏", "me", "—è"]:
            target = message.from_user
        else:
            try:
                if clean.isdigit():
                    target = await client.get_chat(int(clean))
                else:
                    target = await client.get_chat(clean)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
    
    if not target:
        await message.reply("‚ö†Ô∏è –ü—Ä–∏–º–µ—Ä: `–ß–µ–∫ @username` –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    text = generate_card_text(target.id, target.username, target.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    await message.reply(text, reply_markup=get_profile_keyboard(target.id, target.username))

# ========== –ö–û–ú–ê–ù–î–´ –î–õ–Ø –°–û–ó–î–ê–¢–ï–õ–ï–ô ==========
@app.on_message(filters.regex(r"(?i)^\+–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç"))
async def add_president(client, message):
    if not is_owner(message.from_user.id, message.from_user.username):
        await message.reply("‚ùå –ù–∞–∑–Ω–∞—á–∞—Ç—å –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –°–æ–∑–¥–∞—Ç–µ–ª–∏.")
        return
    
    parts = message.text.split(maxsplit=1)
    args = parts[1] if len(parts) > 1 else None
    
    target = None
    if message.reply_to_message:
        target = message.reply_to_message.from_user
    elif args:
        try:
            clean = get_clean_id(args)
            if clean.isdigit():
                target = await client.get_chat(int(clean))
            else:
                target = await client.get_chat(clean)
        except:
            pass
    
    if target:
        remove_all_staff_roles(target.id)
        cursor.execute("INSERT OR REPLACE INTO presidents (user_id) VALUES (?)", (str(target.id),))
        conn.commit()
        await message.reply(f"üëë **{target.first_name}** –Ω–∞–∑–Ω–∞—á–µ–Ω –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º [WARD AntiScam](https://t.me/WardReport)!")

@app.on_message(filters.regex(r"(?i)^\-–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç"))
async def remove_president(client, message):
    if not is_owner(message.from_user.id, message.from_user.username):
        await message.reply("‚ùå –°–Ω–∏–º–∞—Ç—å –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –°–æ–∑–¥–∞—Ç–µ–ª–∏.")
        return
    
    parts = message.text.split(maxsplit=1)
    args = parts[1] if len(parts) > 1 else None
    
    target = None
    if message.reply_to_message:
        target = message.reply_to_message.from_user
    elif args:
        try:
            clean = get_clean_id(args)
            if clean.isdigit():
                target = await client.get_chat(int(clean))
            else:
                target = await client.get_chat(clean)
        except:
            pass
    
    if target:
        if cursor.execute("DELETE FROM presidents WHERE user_id = ?", (str(target.id),)).rowcount > 0:
            conn.commit()
            await message.reply(f"üëë **{target.first_name}** —Å–Ω—è—Ç —Å –ø–æ—Å—Ç–∞ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞.")
        else:
            await message.reply("‚ÑπÔ∏è –ù–µ –±—ã–ª –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º.")

# –î–æ–±–∞–≤—å—Ç–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–æ–ª–µ–π –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å +–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç/-–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========
async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        if not init_database():
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö")
            return
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä—Å–æ–Ω–∞–ª–µ
        await fetch_staff_info()
        
        logger.info("=" * 50)
        logger.info("üöÄ –ë–æ—Ç WARD AntiScam –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
        logger.info(f"üëë –°–æ–∑–¥–∞—Ç–µ–ª–∏: {len(OWNERS)}")
        for name, data in OWNERS.items():
            logger.info(f"  - {name} (ID: {data['id']}, Username: {data['username'] or '–Ω–µ—Ç'})")
        logger.info("=" * 50)
        
        # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        await app.start()
        logger.info("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        logger.info("üì± –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —Å –±–æ—Ç–æ–º")
        
        # –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        await idle()
        
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
    finally:
        # –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        try:
            await app.stop()
            if conn:
                conn.close()
            logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
        except:
            pass

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("\nüëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
